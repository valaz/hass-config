telegram:

    sensor:

      - platform: template
        sensors:

          unavailable_now_light:
            friendly_name: "Всего недоступных светильников - "
            value_template: "{{states.light | selectattr ('state', 'equalto', 'unavailable') | list | length}}"
            icon_template: mdi:counter        

          unavailable_now_switch:
            friendly_name: "Всего недоступных реле - "
            value_template: "{{states.switch | selectattr ('state', 'equalto', 'unavailable') | list | length}}"
            icon_template: mdi:counter 
            
          unavailable_now_sensor:
            friendly_name: "Всего недоступных сенсоров - "
            value_template: "{{states.sensor | selectattr ('state', 'equalto', 'unavailable') | list | length}}"
            icon_template: mdi:counter
            
          unavailable_now_binary_sensor:
            friendly_name: "Всего недоступных бинарных сенсоров - "
            value_template: "{{states.binary_sensor | selectattr ('state', 'equalto', 'unavailable') | list | length}}"
            icon_template: mdi:counter
            
    script:
    
      send_message_1:
        alias: Отправка через сервис уведомлений
        sequence:
        - service: notify.tg_valaz
          data:
            message: "Текущее время - {{ states('sensor.time') }} . Все в порядке"
            
      system_report:
        alias: Отправка отчета о состоянии системы
        sequence:
         - service: notify.tg_valaz
           data:
             message: | 
                 {{"\U0001F4BB"}} Состояние системы
                 {{"\U0001F567"}} Отчет за {{ states('sensor.time_date') }}
                 {{"\U0001F4A1"}} Светильников недоступно - {{ states('sensor.unavailable_now_light') }} 
                 {{"\U0001F50C"}} Свичей недоступно - {{ states('sensor.unavailable_now_switch') }} 
                 {{"\U0001F321"}} Сенсоров недоступно - {{ states('sensor.unavailable_now_sensor') }} 
                 {{"\U0001F51F"}} Бинарных сенсоров недоступно - {{ states('sensor.unavailable_now_binary_sensor') }}   
      climate_report:
        alias: Отправка отчета о состоянии климата
        sequence:
         - service: notify.tg_valaz
           data:
             message: | 
                 {{"\U0001F333"}} Климат в квартире
                 {{"\U0001F567"}} Отчет за {{ states('sensor.time_date') }}
                 {{"\U0001F4FA"}} Гостиная - {{ states('sensor.xiaomi_airpurifier_temperature') }} °C, {{ states('sensor.xiaomi_airpurifier_humidity') }} %
                 {{"\U0001F468"}} Спальня - {{ states('sensor.rm4_mini_temperature') }} °C, {{ states('sensor.rm4_mini_humidity') }} %
                 {{"\U0001F476"}} Детская - {{ states('sensor.0x158d000586695c_temperature') }} °C, {{ states('sensor.0x158d000586695c_humidity') }} %
                 {{"\U0001F52A"}} Кухня - {{ states('sensor.0x158d0005800735_temperature') }} °C, {{ states('sensor.0x158d0005800735_humidity') }} %
      homelab_report:
        alias: Отправка отчета о состоянии homelab
        sequence:
         - service: notify.tg_valaz
           data:
             message: | 
                 {{"\U00002699"}} Homelab
                 {{"\U0001F567"}} Отчет за {{ states('sensor.time_date') }}
                 {{"\U00002600"}} CPU - {{ states('sensor.proxmox_cpu_temperature') }} °C
                 {{"\U0001F4BD"}} Samsung 970 EVO - {{ states('sensor.samsung_ssd_970_evo_250gb_temperature') }} °C
                 {{"\U0001F4BD"}} WD Elements - {{ states('sensor.wdc_wd140edfz_11a0va0_temperature') }} °C
        
# https://apps.timwhitlock.info/emoji/tables/unicode         
    automation:  
        - id: Клавиатура телеграмм бота
          alias: telegram_keyboard
          initial_state: true
          trigger:
          - platform: event
            event_type: telegram_command
            event_data:
              command: '/start'
          action:
          - service: notify.tg_valaz
            data:
              message: 'commands'
              data:
                keyboard:
                  - '/report' 
                  - '/climate' 
                  - '/homelab'

        - id: Отчет при запуске системы
          alias: start_message
          initial_state: true
          trigger:   
             - platform: homeassistant
               event: start          
          action:          
             - service: notify.tg_valaz
               data:
                 message: | 
                     {{"\U0001F4AC"}} Основной сервер Hass 
                     {{"\U0001F567"}} Зафиксирован запуск в {{ states('sensor.time_date') }} 
                     {{"\U0001F4C3"}} Отчет о состоянии будет через 1 минуту   
             - delay: 00:01:10
             - service: script.turn_on
               entity_id: script.system_report
               
        - id: Запрос на отчет             
          alias: send_report
          initial_state: true
          trigger:
          - platform: event
            event_type: telegram_command
            event_data:
              command: '/report'
          action:
           - service: script.turn_on
             entity_id: 
                - script.system_report
                
        - id: Запрос на климат             
          alias: send_climate_report
          initial_state: true
          trigger:
          - platform: event
            event_type: telegram_command
            event_data:
              command: '/climate'
          action:
           - service: script.turn_on
             entity_id: 
                - script.climate_report
                
        - id: Запрос на homelab             
          alias: send_homelab_report
          initial_state: true
          trigger:
          - platform: event
            event_type: telegram_command
            event_data:
              command: '/homelab'
          action:
           - service: script.turn_on
             entity_id: 
                - script.homelab_report
                
                
        - id: Увлажнитель выключился
          alias: humidifier_turned_off 
          initial_state: true
          trigger:   
             - platform: state
               entity_id: switch.philips_humidifier
               from: "on"
               to: "off"
               for: "00:00:20"
          condition:
            - condition: and
              conditions:
                - condition: state
                  entity_id: switch.0x4cf8cdf3c777c79_switch
                  state: 'on'
          action:
             - service: notify.tg_valaz
               data:
                 message: | 
                     {{"\U0001F4A7"}} В увлажнителе закончилась вода или он был выключен вручную.
                
        - id: Увлажнитель включился
          alias: humidifier_turned_on
          initial_state: true
          trigger:   
             - platform: state
               entity_id: switch.philips_humidifier
               from: "off"
               to: "on"
          condition:
            - condition: and
              conditions:
                - condition: state
                  entity_id: switch.0x4cf8cdf3c777c79_switch
                  state: 'on'
          action:
             - service: notify.tg_valaz
               data:
                 message: | 
                     {{"\U0001F4A7"}} Увлажнитель снова работает.
                
        - id: Лампа недоступна
          alias: light_is_offline 
          initial_state: true
          trigger:   
             - platform: state
               entity_id: light.0x158d00052b3ad9_light
               to: "unavailable"
               for:
                 minutes: 2
          action:
             - service: notify.tg_valaz
               data:
                 message: | 
                     {{"\U0001F4A1"}} Лампа в гардеробе была выключена вручную.
                     
        - id: Лампа доступна
          alias: light_is_online 
          initial_state: true
          trigger:   
             - platform: state
               entity_id: light.0x158d00052b3ad9_light
               from: "unavailable"
          action:
             - service: notify.tg_valaz
               data:
                 message: | 
                     {{"\U0001F4A1"}} Лампа в гардеробе снова доступна.
                     
                     
                     
        - id: CPU горячий
          alias: cpu_temp_is_hot 
          initial_state: true
          trigger:   
             - platform: numeric_state
               entity_id: sensor.cpu_temp_package
               above: 84
          action:
             - service: notify.tg_valaz
               data:
                 message: | 
                     {{"\U0001F975"}} Температура CPU увеличилась - {{ states('sensor.proxmox_cpu_temperature') }} °C.
                     
        - id: CPU теплый
          alias: cpu_temp_is_ok 
          initial_state: true
          trigger:   
             - platform: numeric_state
               entity_id: sensor.cpu_temp_package
               below: 85
          action:
             - service: notify.tg_valaz
               data:
                 message: | 
                     {{"\U0001F976"}} Температура CPU уменьшилась - {{ states('sensor.proxmox_cpu_temperature') }} °C.
                     
        - id: WD Elements горячий
          alias: wd_elements_is_hot 
          initial_state: true
          trigger:   
             - platform: numeric_state
               entity_id: sensor.omv_sdc
               above: 44
          action:
             - service: notify.tg_valaz
               data:
                 message: | 
                     {{"\U0001F4BD"}} Температура WD Elements увеличилась - {{ states('sensor.omv_sdc') }} °C.
                     
        - id: WD Elements теплый
          alias: wd_elements_is_ok 
          initial_state: true
          trigger:   
             - platform: numeric_state
               entity_id: sensor.omv_sdc
               below: 45
          action:
             - service: notify.tg_valaz
               data:
                 message: | 
                     {{"\U0001F4BD"}} Температура WD Elements уменьшилась - {{ states('sensor.omv_sdc') }} °C.

        - id: Roborock зараяжен
          alias: roborock_is_charged 
          initial_state: false
          trigger:   
              - platform: numeric_state
                entity_id: sensor.roborock_s5_battery
                above: 90
                for:
                  minutes: 1
            #  - platform: state
            #   entity_id: binary_sensor.roborock_is_charged
            #   from: "off"
            #   to: "on"
          action:
             - service: notify.tg_valaz
               data:
                 message: | 
                     {{"\U0001F9F9"}}{{"\U0001F50B"}} Пылесос готов к уборке.

        - id: Roborock завершил уборку
          alias: roborock_finished_cleaning 
          initial_state: true
          trigger:   
             - platform: state
               entity_id: vacuum.roborock_s5
               from: "returning"
               to: "docked"
          action:
             - service: notify.tg_valaz
               data:
                 message: | 
                     {{"\U0001F9F9"}} Пылесос завершил уборку.
                     {{"\U0001F3E0"}} Площадь уборки - {{ states('sensor.roborock_s5_cleaned_area') }} m2.
                     {{"\U000023F1"}} Время уборки - {{ states('sensor.roborock_s5_cleaning_time') }} мин.
                     {{"\U0001F50B"}} Уровень заряда - {{ states('sensor.roborock_s5_battery') }} %.

        - id: Roborock начал уборку
          alias: roborock_started_cleaning 
          initial_state: true
          trigger:   
             - platform: state
               entity_id: vacuum.roborock_s5
               from: "docked"
               to: "cleaning"
          action:
             - service: notify.tg_valaz
               data:
                 message: | 
                     {{"\U0001F9F9"}} Пылесос начал уборку.
                     
        - id: Torrent is completed
          alias: torrent_is_completed
          trigger:
            platform: event
            event_type: transmission_downloaded_torrent
          action:
            - service: notify.tg_valaz
              data:
                title: "Загрузка завершена!"
                message: |
                    {{"\U00002714"}} {{trigger.event.data.name}}
                     
        - id: Torrent is started
          alias: torrent_is_started
          trigger:
            platform: event
            event_type: transmission_started_torrent
          action:
            - service: notify.tg_valaz
              data:
                title: "Загрузка началась!"
                message: |
                    {{"\U00002795"}} {{trigger.event.data.name}}
                     
        - id: Torrent is removed
          alias: torrent_is_removed
          trigger:
            platform: event
            event_type: transmission_removed_torrent
          action:
            - service: notify.tg_valaz
              data:
                title: "Торрент удален!"
                message: |
                    {{"\U00002796"}} {{trigger.event.data.name}}
                     

          
          
          
          
          
          